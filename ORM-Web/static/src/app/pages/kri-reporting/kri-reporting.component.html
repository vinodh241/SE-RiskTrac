<mat-toolbar class="fontSize">
    <span>Key Risk Indicator | Reported KRI(s)</span>
    <span class="spacer"></span>
</mat-toolbar>
<div class="container">
    <div class="actions-container">
        <div class="left-action">
            <div class="form-group">
                <label class="dropdown-label">Group</label>
                <mat-form-field appearance="standard">
                    <mat-select [(ngModel)]="kriService.kriReportedSelectedGroup" (selectionChange)="onGroupChange()">
                        <mat-option value="">All</mat-option>
                        <mat-option *ngFor="let group of getGroupList()" [value]="group.GroupID">{{group.GroupName}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-group">
                <label class="dropdown-label">Unit</label>
                <mat-form-field appearance="standard">
                    <mat-select [disabled]="!kriService.kriReportedSelectedGroup"
                        [(ngModel)]="kriService.kriReportedSelectedUnit" (selectionChange)="onUnitChange()"
                        aria-multiline="true">
                        <mat-option value="">All</mat-option>
                        <mat-option *ngFor="let unit of getUnitList()" [value]="unit.UnitID">{{unit.UnitName}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="reporting-form-group">
                <label>Reporting Period: {{kriService.kriReportedData?.reportingPeriod[0]?.ReportingPeriod}}</label>
            </div>
        </div>
        <div class="right-action">
            <div class="form-group">
                <mat-form-field appearance="standard">
                    <mat-label>Search</mat-label>
                    <input matInput (keyup)="applySearchFilter($event)" #input>
                </mat-form-field>
                <button *ngIf="getAllUnitRowsFilteredLength()" mat-icon-button matTooltipPosition="right"
                    (click)="exportAsExcelKRiReporting()">
                    <img src="assets/icon-excel.svg">
                </button>
            </div>
        </div>
    </div>


    <div class="container-body">
        <mat-card class="reported-card">
            <mat-card-content class="reported-card-content">
                <div class="card-button" (click)="onClickAll()">
                    <p class="card-button-status">All</p>
                    <p class="card-button-number">{{kriService.kriReportedAllMetricsNo}}</p>
                </div>
                <div class="card-button" (click)="onClickMeasured()">
                    <p class="card-button-status">Measured</p>
                    <p class="card-button-number">{{kriService.kriReportedMeasuredMetricsNo}}</p>
                </div>
                <div class="card-button" (click)="onClickNotMeasured()">
                    <p class="card-button-status">Not Measured</p>
                    <p class="card-button-number">{{kriService.kriReportedNotMeasuredMetricsNo}}</p>
                </div>
                <div class="card-button" (click)="onClickReported()">
                    <p class="card-button-status">Reported</p>
                    <p class="card-button-number">{{kriService.kriReportedMetricsNo}}</p>
                </div>
                <div class="card-button" (click)="onClickApproved()">
                    <p class="card-button-status">Approved</p>
                    <p class="card-button-number">{{kriService.kriApprovedMetricsNo}}</p>
                </div>
                <div class="card-button" (click)="onClickRejected()">
                    <p class="card-button-status">Rejected</p>
                    <p class="card-button-number">{{kriService.kriRejectedMetricsNo}}</p>
                </div>
            </mat-card-content>
            <div class="hr-line">
                <hr>
            </div>
            <mat-card-footer class="reported-card-footer">
                <mat-icon><img src="assets/icons/icon-history-bottom.svg" width="100%"></mat-icon>
                <p class="historical-link" [routerLink]="['/kri-historical-reporting']">
                    Historical Reported KRI(s)
                </p>
            </mat-card-footer>
        </mat-card>
        <div class="expansion-section" id="kriReportiD" *ngIf="kriService.kriReportedAllMetricsNo; else noDataTemplate">
            <ng-container *ngFor="let data of kriService.kriReportedSelectedUnitNameRows; let i=index;">
                <div id="{{'KriReporting'+i}}" *ngIf="data.Metrics.filteredData.length > 0">
                    <mat-expansion-panel class="expansion-panel" [expanded]="data.IsExpanded" (opened)="data.IsExpanded = true" (closed)="data.IsExpanded = false">
                        <mat-expansion-panel-header class="expansion-header">
                            <mat-panel-title class="expansion-panel-title">
                                <label class="expansion-group-title title-label">{{data.GroupName}} |
                                    {{data.UnitName}}</label>
                                <label class="expansion-status-title"><span
                                        class="title-label">Status:</span>&nbsp;{{getUnitNameStatus(data.Metrics.filteredData)}}</label>
                                <label class="expansion-length-title"><span
                                        class="title-label">{{data.Metrics.filteredData.length}}</span>&nbsp;KRI(s)
                                    <button *ngIf="data.Metrics.filteredData.length" mat-icon-button
                                        matTooltipPosition="right" (click)="exportAsExcel(data)">
                                        <img src="assets/icon-excel.svg">
                                    </button>
                                </label>
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <mat-panel-description style="margin-right: 0px;">
                            <table *ngIf="data.Metrics.data.length" mat-table [dataSource]="data.Metrics"
                                class="mat-elevation-z8">

                                <ng-container *ngFor="let item of displayedColumns" [matColumnDef]="item">
                                    <th mat-header-cell *matHeaderCellDef></th>
                                    <td mat-cell *matCellDef="let element"> {{element[item]}}</td>
                                </ng-container>

                                <ng-container *ngFor="let item of periodColumns;let i = index" [matColumnDef]="item">
                                    <th mat-header-cell *matHeaderCellDef>{{i == 3? 'KRI Value': i == 5? 'Status':
                                        item}}
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <span
                                            [ngClass]="{'threshold-value': item.includes('ThresholdValue'), 'measurement-value': i == 2}"
                                            [ngStyle]="{'background-color': item.includes('ThresholdValue')? element['ColorCode']: ''}">
                                            {{(i == 1)? (utils.formatDate(element[item])): element[item]}}
                                            {{(i == 2) && !([undefined, null, ''].includes(element[item]))? '%': ''}}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container *ngFor="let item of thresholdColumns; let i = index;"
                                    [matColumnDef]="item">
                                    <th class="text-center threshold-header" mat-header-cell *matHeaderCellDef>
                                        {{i == 0? '1': i ==1? '2': i == 2? '3': i ==3? '4': '5'}}</th>
                                    <td class="text-center" mat-cell *matCellDef="let element">
                                        <ng-container *ngIf="element[item] != undefined">
                                            <ng-container *ngIf="element[item] != undefined">
                                                {{(i == 0)? ((element[item] <= (element[thresholdColumns[i + 1]] + 1))? '>=' : '<=') : '' }}
                                                {{((i == 1) || (i == 2) || (i == 3))?  ((element[item] <= (element[thresholdColumns[i + 1]] + 1))? '>=' : '<=') : '' }}
                                                {{(i == 4) ? '=' : '' }}
                                            </ng-container>
                                        </ng-container>{{element[item]}}<span *ngIf="element[item] != undefined">%</span>
                                    </td>
                                </ng-container>

                                <ng-container *ngFor="let header of displayedHeaders; let i = index"
                                    [matColumnDef]="header">
                                    <ng-container *ngIf="(i < 5)">
                                        <th [ngClass]="{'frequency-header': (i == 2)}" mat-header-cell *matHeaderCellDef
                                            [attr.rowspan]="2">
                                            {{i == 0? 'KRI Code': i == 1? 'Indicator': i == 2? 'Measurement Frequency':
                                            i ==
                                            3?
                                            'Target': 'KRI Type'}}</th>
                                    </ng-container>
                                    <ng-container *ngIf="(i == 5)">
                                        <th class="text-center" mat-header-cell *matHeaderCellDef [attr.colspan]="6">
                                            {{kriService.kriReportedData?.reportingPeriod[0]?.ReportingPeriod}}
                                        </th>
                                    </ng-container>
                                    <ng-container *ngIf="(i == 6)">
                                        <th class="text-center" mat-header-cell *matHeaderCellDef [attr.colspan]="5">
                                            Threshold Value
                                        </th>
                                    </ng-container>
                                </ng-container>

                                <span *ngIf="isKriExportExcel;else temp">
                                    <tr mat-header-row *matHeaderRowDef="displayedHeaders"></tr>
                                    <tr mat-header-row *matHeaderRowDef="periodColumns.concat(thresholdColumns)"></tr>
                                </span>
                                <ng-template #temp>
                                    <tr mat-header-row *matHeaderRowDef="displayedHeaders"></tr>
                                    <tr mat-header-row *matHeaderRowDef="periodColumns.concat(thresholdColumns)"></tr>
                                </ng-template>
                                <tr mat-row
                                    *matRowDef="let row; columns: displayedColumns.concat(periodColumns, thresholdColumns)">
                                </tr>

                            </table>
                        </mat-panel-description>
                    </mat-expansion-panel>
                </div>
            </ng-container>
        </div>
        <ng-template #noDataTemplate>
            <p class="no-data">No Data Found</p>
        </ng-template>
    </div>
</div>
